# ADR: Онлайн открытие депозитов (MVP)

**Статус:** Принято
**Дата:** 2025-11-24
**Авторы:** Команда цифровой трансформации

---

## Контекст

Банк «Стандарт» стремится расширить онлайн-каналы обслуживания для привлечения молодой аудитории. Текущий процесс открытия депозитов требует личного визита в отделение и участия бэк-офиса, что создаёт издержки и неудобства для клиентов.

### Текущая ситуация:
- Клиенты могут открыть депозит только в отделении
- Ставки вручную рассчитываются в Excel сотрудниками отдела кредитования
- Согласование ставки происходит через email между бэк-офисами
- Процесс занимает 20-60 минут в зависимости от типа ставки
- Интернет-банк позволяет только платежи и открытие текущих счетов
- Сайт имеет только маркетинговую информацию

### Бизнес-цели:
**MVP (6 месяцев):** Клиент может подать заявку на депозит в интернет-банке и на сайте. Бэк-офис обрабатывает заявки по текущему процессу.

**Целевое состояние (1 год):** Полностью автоматическое открытие депозита без участия бэк-офиса.

---

## Use Cases

### UC-1: Подача заявки на депозит с сайта (новый клиент)

**Акторы:** Новый клиент (не клиент банка), Сотрудник кол-центра, Сотрудник бэк-офиса депозитов

**Предусловия:**
- Клиент зашёл на сайт банка
- Сайт отображает актуальные ставки депозитов

**Main Flow (Happy Path):**
1. Клиент просматривает список доступных депозитов с актуальными ставками
2. Клиент выбирает интересующий продукт
3. Клиент заполняет форму заявки: ФИО, номер телефона
4. Система валидирует введённые данные
5. Клиент подтверждает подачу заявки
6. Система создаёт заявку и передаёт её в систему кол-центра
7. Клиент видит сообщение о принятии заявки и ожидании звонка
8. Сотрудник кол-центра получает заявку в своей системе
9. Сотрудник кол-центра звонит клиенту, уточняет детали
10. Сотрудник кол-центра может предложить особые условия (персонализированную ставку)
11. Сотрудник передаёт заявку в АБС для обработки бэк-офисом
12. Сотрудник бэк-офиса депозитов обрабатывает заявку в АБС
13. Сотрудник бэк-офиса согласовывает ставку (стандартный или специальный процесс)
14. АБС отправляет СМС клиенту с подтверждённой ставкой и приглашением в отделение
15. Клиент приходит в отделение для идентификации и подписания документов
16. Сотрудник отделения открывает депозит в АБС
17. АБС отправляет СМС клиенту о создании депозита

**Alternative Flows:**
- **AF-1:** Некорректные данные в форме → система показывает ошибки валидации, клиент исправляет
- **AF-2:** Клиент не отвечает на звонок кол-центра → заявка переходит в статус "Ожидание контакта", повторный звонок через установленный интервал
- **AF-3:** Клиент отказывается от депозита при звонке → заявка отменяется, клиент получает СМС об отмене
- **AF-4:** Сбой при создании заявки → система показывает ошибку и предлагает повторить попытку позже
- **AF-5:** Клиент не приходит в отделение в течение N дней → заявка аннулируется

---

### UC-2: Подача заявки на депозит в интернет-банке (существующий клиент)

**Акторы:** Клиент банка (авторизованный), Сотрудник бэк-офиса депозитов

**Предусловия:**
- Клиент авторизован в интернет-банке
- У клиента есть активные счета
- Система отображает актуальные ставки

**Main Flow (Happy Path):**
1. Клиент просматривает список доступных депозитов с общими ставками
2. Система отображает персонализированные ставки для клиента (если применимо)
3. Клиент выбирает продукт депозита
4. Клиент указывает счёт списания и сумму депозита
5. Система валидирует наличие средств на счёте
6. Система отображает итоговые условия депозита (ставка, срок, доход)
7. Клиент подтверждает подачу заявки
8. Система запрашивает СМС-код для подтверждения операции
9. Клиент вводит СМС-код
10. Система валидирует СМС-код
11. Система создаёт заявку на депозит
12. Заявка передаётся в АБС для обработки бэк-офисом
13. Клиент видит статус заявки "В обработке"
14. Сотрудник бэк-офиса депозитов получает заявку в АБС
15. Сотрудник проверяет заявку и согласовывает ставку
16. Сотрудник подтверждает условия депозита в АБС
17. АБС отправляет СМС клиенту о подтверждении ставки
18. Сотрудник открывает депозит в АБС (резервирует средства, создаёт договор)
19. АБС отправляет СМС клиенту об открытии депозита
20. Клиент видит открытый депозит в интернет-банке

**Alternative Flows:**
- **AF-1:** Недостаточно средств на счёте → система показывает ошибку, предлагает выбрать другой счёт или сумму
- **AF-2:** Неверный СМС-код (1-2 попытка) → система предлагает повторить ввод
- **AF-3:** Неверный СМС-код (3 попытка) → операция блокируется на N минут
- **AF-4:** Сотрудник бэк-офиса отклоняет заявку → клиент получает СМС с причиной отклонения, статус "Отклонено"
- **AF-5:** Таймаут ввода СМС-кода → операция отменяется, клиент может начать заново
- **AF-6:** Сбой при передаче заявки в АБС → заявка сохраняется в очередь для повторной отправки, клиент видит статус "В обработке"
- **AF-7:** Персонализированная ставка не рассчитана → клиент видит только общие ставки

---

### UC-3: Обработка заявки сотрудником бэк-офиса депозитов

**Акторы:** Сотрудник бэк-офиса депозитов, Сотрудник бэк-офиса кредитов (для специальных ставок)

**Предусловия:**
- Заявка поступила в АБС из интернет-банка, сайта или кол-центра
- У сотрудника есть доступ к АБС

**Main Flow (Happy Path):**
1. Сотрудник видит новую заявку в АБС
2. Сотрудник открывает заявку и проверяет данные клиента
3. Система отображает актуальную ставку из справочника ставок
4. Сотрудник проверяет соответствие параметров депозита условиям банка
5. Если ставка стандартная → сотрудник подтверждает её
6. Система отправляет СМС клиенту о подтверждении ставки
7. Сотрудник создаёт депозит в АБС (резервирует средства для ИБ-клиента)
8. Система отправляет СМС клиенту об открытии депозита
9. Заявка переходит в статус "Выполнено"

**Alternative Flows:**
- **AF-1:** Требуется специальная ставка (VIP-клиент, крупная сумма):
  1. Сотрудник запрашивает данные у бэк-офиса кредитов (уровень кредитного риска)
  2. Бэк-офис кредитов анализирует риски в своём разделе АБС
  3. Бэк-офис кредитов передаёт данные обратно
  4. Сотрудник депозитов рассчитывает специальную ставку
  5. Сотрудник подтверждает ставку → продолжение Main Flow с п.6
- **AF-2:** Данные клиента некорректны → сотрудник отклоняет заявку с указанием причины, СМС клиенту
- **AF-3:** Клиент не соответствует условиям депозита → заявка отклоняется, СМС клиенту
- **AF-4:** Недостаточно средств на счёте (для ИБ) → заявка отклоняется, СМС клиенту

---

### UC-4: Управление ставками депозитов

**Акторы:** Сотрудник бэк-офиса кредитов, Сотрудник бэк-офиса депозитов

**Предусловия:**
- Сотрудники имеют доступ к системе управления ставками
- Известна текущая ставка рефинансирования ЦБ

**Main Flow (Happy Path):**
1. Сотрудник бэк-офиса кредитов ежедневно анализирует:
   - Текущую ставку рефинансирования ЦБ
   - Количество выданных кредитов и депозитов
   - Уровень кредитного риска банка
2. Сотрудник рассчитывает актуальные ставки депозитов
3. Сотрудник вносит ставки в систему управления ставками
4. Система валидирует ставки (диапазоны, соответствие продуктам)
5. Система публикует ставки для всех каналов:
   - Сайт
   - Интернет-банк
   - Система кол-центра
   - АБС (для бэк-офиса)
6. Ставки становятся доступны в течение N минут

**Alternative Flows:**
- **AF-1:** Некорректные значения ставок → система показывает ошибку, сотрудник исправляет
- **AF-2:** Сбой публикации в одном из каналов → система повторяет попытку, логирует ошибку, уведомляет администратора

---

## Функциональные требования

### Депозиты на сайте:
- Отображение списка депозитов с актуальными ставками
- Форма подачи заявки: ФИО, номер телефона
- Валидация данных формы
- Шифрование трафика (HTTPS/TLS)
- Интеграция с системой кол-центра для передачи заявок

### Депозиты в интернет-банке:
- Отображение списка депозитов с общими и персонализированными ставками
- Форма подачи заявки: выбор счёта, сумма депозита
- Проверка наличия средств на счёте
- Подтверждение через СМС-код (существующий функционал)
- Отображение статуса заявки
- Отображение открытых депозитов

### АБС:
- Приём заявок из интернет-банка и кол-центра
- Интерфейс обработки заявок для бэк-офиса
- Интеграция с системой управления ставками
- Отправка СМС-уведомлений через СМС-шлюз
- Создание депозитов

### Система управления ставками (новая):
- Интерфейс ввода и управления ставками
- Валидация ставок
- API для публикации ставок во все системы
- История изменений ставок

### Система кол-центра:
- Приём заявок с сайта
- Интерфейс обработки заявок операторами
- Интеграция с АБС для передачи заявок

---

## Нефункциональные требования

### Производительность:
- Отклик веб-интерфейсов < 1 секунды (целевое значение: < 200 мс)
- Загрузка справочных данных (ставки) < 1 секунды
- Обработка заявки бэк-офисом: в течение рабочего дня

### Надёжность:
- Доступность 99.9% (24/7)
- Шифрование трафика HTTPS/TLS
- Двухфакторная аутентификация (СМС) для операций в интернет-банке
- Избежать прямого API доступа к АБС (БД перегружена)
- Асинхронная обработка заявок через очереди
- Идемпотентность операций (защита от дублирования)

### Масштабируемость:
- Горизонтальное масштабирование интернет-банка
- Поддержка распределения нагрузки между ЦОД
- Буферизация нагрузки на АБС через очереди

### Безопасность:
- Разграничение доступа между бэк-офисами депозитов и кредитов
- Аудит всех операций с заявками
- Rate limiting для защиты от перегрузки

### Поддерживаемость:
- Использование существующих технологий банка
- Минимальные изменения в ядре интернет-банка
- Реализация силами внутренней команды (где возможно)
- Документация API и процессов

---

## Решение

### Архитектурный подход

Для реализации MVP предлагается **гибридная архитектура**:
1. **Микросервисный слой** для новых функций (управление заявками, ставки)
2. **Интеграция через очереди сообщений** для снижения нагрузки на АБС
3. **API Gateway** как единая точка входа для внешних каналов
4. **Кэширование** для ускорения загрузки справочных данных

### Ключевые компоненты решения:

#### 1. **Deposit Application Service** (новый микросервис)
- **Технологии:** Java Spring Boot, PostgreSQL (опыт есть у команды кол-центра)
- **Функции:**
  - Приём заявок из всех каналов (сайт, интернет-банк)
  - Валидация заявок
  - Управление статусами заявок
  - Публикация заявок в очередь для АБС
  - API для получения статусов
- **Обоснование:** Единая точка управления заявками, избежание дублирования логики

#### 2. **Rate Management Service** (новый микросервис)
- **Технологии:** Java Spring Boot, PostgreSQL
- **Функции:**
  - Управление ставками депозитов
  - API для публикации ставок
  - Валидация ставок
  - История изменений
  - Кэш ставок (Redis)
- **Обоснование:** Централизованное управление ставками вместо Excel

#### 3. **API Gateway**
- **Технологии:** Nginx + Kong / Spring Cloud Gateway
- **Функции:**
  - Единая точка входа
  - Авторизация и аутентификация
  - Rate limiting
  - Логирование и мониторинг
  - Маршрутизация запросов
- **Обоснование:** Безопасность, управляемость, наблюдаемость

#### 4. **Message Queue (Kafka)**
- **Функции:**
  - Очередь заявок для АБС
  - Буферизация нагрузки
  - Гарантированная доставка
- **Обоснование:** Защита АБС от перегрузки, надёжность

**Ограничение MVP:** Интернет-банк (ASP.NET MVC) несовместим с Kafka. Решение:
- Для MVP: HTTP API вызовы интернет-банк → Deposit Application Service
- Deposit Application Service публикует в Kafka
- На 2-й фазе: миграция интернет-банка на микросервисы

#### 5. **АБС Integration Adapter** (новый компонент в АБС)
- **Технологии:** PL-SQL процедуры + Java-адаптер
- **Функции:**
  - Чтение заявок из Kafka
  - Запись заявок в таблицы АБС
  - Чтение ставок из Rate Management Service
  - Отправка статусов обратно в Deposit Application Service
- **Обоснование:** Изоляция АБС от прямых вызовов

#### 6. **Доработки существующих систем:**

**Сайт (PHP, React.js):**
- Страница с депозитами (интеграция с Rate Management Service через API Gateway)
- Форма подачи заявки (отправка в Deposit Application Service через API Gateway)

**Интернет-банк (ASP.NET MVC):**
- Страница с депозитами и персонализированными ставками
- Форма подачи заявки с СМС-подтверждением
- Отображение статусов заявок
- Интеграция с Deposit Application Service через HTTP API

**Система кол-центра:**
- Интерфейс просмотра заявок с сайта
- Передача заявок в Deposit Application Service
- Интеграция с Rate Management Service для просмотра ставок

**АБС:**
- Новые таблицы для заявок
- Интерфейс обработки заявок для бэк-офиса
- Интеграция с Rate Management Service (чтение ставок)
- АБС Integration Adapter

### Диаграммы

См. файлы:
- `C4_Context_Deposits_MVP.png` - диаграмма контекста
- `C4_Container_Deposits_MVP.png` - диаграмма контейнеров

### Поток данных (MVP):

#### Заявка с сайта:
```
Клиент (сайт)
  → API Gateway
  → Deposit Application Service (создание заявки)
  → База заявок (PostgreSQL)
  → Система кол-центра (уведомление через webhook/API)
  → Оператор обрабатывает заявку
  → Передача в АБС через Deposit Application Service
  → Kafka (очередь заявок)
  → АБС Integration Adapter
  → АБС (таблица заявок)
  → Бэк-офис депозитов обрабатывает
  → АБС → СМС-шлюз → Клиент (СМС)
```

#### Заявка из интернет-банка:
```
Клиент (интернет-банк)
  → API Gateway
  → Deposit Application Service (создание заявки)
  → База заявок (PostgreSQL)
  → Kafka (очередь заявок)
  → АБС Integration Adapter
  → АБС (таблица заявок)
  → Бэк-офис депозитов обрабатывает
  → АБС → СМС-шлюз → Клиент (СМС)
  → АБС → Deposit Application Service (обновление статуса)
  → Интернет-банк отображает статус
```

#### Управление ставками:
```
Сотрудник бэк-офиса кредитов
  → Rate Management Service (веб-интерфейс)
  → База ставок (PostgreSQL)
  → Публикация ставок:
    ├→ Сайт (API)
    ├→ Интернет-банк (API)
    ├→ Система кол-центра (API)
    └→ АБС (через АБС Integration Adapter)
  → Redis кэш (ускорение загрузки)
```

---

## Альтернативы

### Альтернатива 1: Прямая интеграция интернет-банка с АБС
**Описание:** Сохранить текущий подход - прямое обращение к БД АБС

**Преимущества:**
- Не требуется разработка новых компонентов
- Меньше изменений в архитектуре

**Недостатки:**
- БД АБС уже перегружена (высокий риск)
- Нарушение требования R-6 (избежать прямого API доступа к АБС)
- Нет буферизации нагрузки
- Сложность масштабирования
- **Отклонено** из-за критических рисков для работоспособности АБС

### Альтернатива 2: Реализация всего в АБС
**Описание:** Добавить все новые функции (управление заявками, ставки, API) в АБС

**Преимущества:**
- Не требуется разработка отдельных микросервисов
- Вся логика в одном месте

**Недостатки:**
- АБС на устаревшем стеке (Delphi, PL-SQL)
- Команда АБС перегружена
- Невозможно горизонтальное масштабирование АБС
- Увеличение нагрузки на критичную систему
- Сложность поддержки
- **Отклонено** из-за технических ограничений и рисков

### Альтернатива 3: Полная миграция интернет-банка на микросервисы
**Описание:** Сразу переписать интернет-банк на микросервисную архитектуру с Kafka

**Преимущества:**
- Современная архитектура
- Нативная поддержка Kafka
- Лучшая масштабируемость

**Недостатки:**
- Очень длительная разработка (не уложиться в 6 месяцев MVP)
- Высокие риски
- Большие затраты
- Требуется переобучение команды подрядчика
- **Отклонено** из-за сроков и бюджета MVP

---

## Последствия

### Положительные:
+ Снижение нагрузки на АБС (буферизация через Kafka)
+ Централизованное управление ставками (замена Excel)
+ Единая точка управления заявками из всех каналов
+ Возможность горизонтального масштабирования новых компонентов
+ Быстрая загрузка справочных данных (кэширование)
+ Прозрачность обработки заявок для клиентов (статусы)
+ Использование существующей экспертизы (Java Spring Boot)
+ Упрощение миграции на полностью микросервисную архитектуру в будущем

### Отрицательные:
- Необходимость разработки и поддержки новых микросервисов
- Временное решение для интернет-банка (HTTP API вместо Kafka)
- Необходимость обучения команды работе с Kafka
- Усложнение архитектуры (больше компонентов)
- Необходимость мониторинга распределённой системы
- Интернет-банк остаётся на устаревшем стеке (.NET Framework 4.5)

### Риски:
**Риск 1:** Команда может не справиться с новыми технологиями (Kafka)
- *Митигация:* Обучение команды, привлечение консультантов на этап внедрения

**Риск 2:** Проблемы производительности Kafka при высокой нагрузке
- *Митигация:* Нагрузочное тестирование до продакшена, настройка партиций

**Риск 3:** Несогласованность данных между системами
- *Митигация:* Идемпотентность операций, логирование, мониторинг

**Риск 4:** Увеличение времени разработки из-за новой архитектуры
- *Митигация:* Итеративная разработка, прототипирование, декомпозиция задач

---

## Зависимости

- Rate Management Service должен быть разработан первым (нужен для всех систем)
- API Gateway должен быть готов до интеграции сайта и интернет-банка
- Kafka-кластер должен быть развёрнут и протестирован до разработки Deposit Application Service
- АБС Integration Adapter зависит от готовности Kafka и Deposit Application Service

---

## Метрики успеха

- Время обработки заявки бэк-офисом: < 4 часов (в рабочее время)
- Отклик API < 200 мс (95 перцентиль)
- Загрузка ставок < 500 мс
- Доступность системы 99.9%
- Количество дублирующихся заявок = 0
- Нагрузка на БД АБС: не увеличивается (или уменьшается)
- Конверсия заявка → открытый депозит > 70%

---

## Следующие шаги

1. Утверждение архитектурного решения стейкхолдерами
2. Декомпозиция задач по системам (см. Task 4)
3. Оценка сроков и бюджета менеджером проекта
4. Разработка RoadMap (см. Task 4)
5. Прототипирование Rate Management Service
6. Настройка Kafka-кластера в тестовой среде

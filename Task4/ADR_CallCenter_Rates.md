# ADR: Передача ставок депозитов в кол-центры

**Статус:** Принято
**Дата:** 2025-11-24
**Авторы:** Команда цифровой трансформации
**Связан с:** ADR "Онлайн открытие депозитов (MVP)"

---

## Контекст

После запуска маркетинговой кампании по онлайн-депозитам ожидается значительное увеличение звонков в кол-центр банка. Основная аудитория банка — пожилые люди, которым потребуется консультация по телефону.

### Текущая ситуация:
- Операторы кол-центра НЕ имеют доступа к актуальным ставкам депозитов
- Ставки рассчитываются ежедневно в Excel сотрудниками бэк-офиса кредитов
- При звонке клиента оператор не может проконсультировать по ставкам
- Партнёрский кол-центр (100 операторов) может быть подключен при перегрузке
- Партнёрский кол-центр работает во внешней системе, API-интеграция невозможна

### Проблема:
Операторы кол-центров (внутреннего и партнёрского) должны консультировать клиентов по актуальным ставкам депозитов, но не имеют к ним доступа.

### Бизнес-цели:
- Обеспечить операторов кол-центра актуальными ставками депозитов
- Подключить партнёрский кол-центр для обработки увеличенного потока звонков
- Снизить нагрузку на внутренний кол-центр
- Улучшить качество обслуживания клиентов

---

## Use Cases

### UC-1: Консультация клиента оператором кол-центра банка

**Акторы:** Клиент, Оператор кол-центра банка

**Предусловия:**
- Оператор авторизован в системе кол-центра
- Актуальные ставки загружены в систему кол-центра

**Main Flow:**
1. Клиент звонит в кол-центр банка
2. Система кол-центра распределяет звонок оператору
3. Оператор принимает звонок, идентифицирует клиента (если клиент банка)
4. Клиент спрашивает об условиях депозита
5. Оператор открывает раздел "Депозиты" в системе кол-центра
6. Система отображает список депозитных продуктов с актуальными ставками
7. Оператор консультирует клиента по ставкам и условиям
8. Клиент интересуется конкретным продуктом
9. Оператор предлагает создать заявку на депозит
10. Если клиент согласен → переход к UC-2 (создание заявки)
11. Если клиент отказывается → оператор завершает звонок

**Alternative Flows:**
- **AF-1:** Ставки не загружены в систему → оператор видит ошибку, эскалирует в техподдержку
- **AF-2:** Клиент спрашивает о персональной ставке (VIP) → оператор создаёт обращение, бэк-офис депозитов рассчитает индивидуально
- **AF-3:** Ставки устарели (> 24 часов) → система показывает предупреждение, оператор уточняет у бэк-офиса

---

### UC-2: Консультация клиента оператором партнёрского кол-центра

**Акторы:** Клиент, Оператор партнёрского кол-центра

**Предусловия:**
- Партнёрский кол-центр подключен к обработке звонков
- Актуальные ставки переданы в систему партнёрского кол-центра
- Оператор обучен по скрипту консультирования

**Main Flow:**
1. Клиент звонит в общий номер банка
2. Телефония переводит звонок в партнёрский кол-центр (при перегрузке основного)
3. Оператор партнёрского кол-центра принимает звонок
4. Оператор следует скрипту консультации
5. Оператор открывает файл с актуальными ставками в своей системе
6. Система партнёрского кол-центра отображает последний загруженный файл со ставками
7. Оператор консультирует клиента по ставкам и условиям
8. Оператор предлагает клиенту:
   - Вариант A: Подать заявку онлайн (на сайте или в интернет-банке)
   - Вариант B: Перевести на внутренний кол-центр для создания заявки
   - Вариант C: Прийти в отделение
9. Оператор фиксирует результат звонка в своей системе

**Alternative Flows:**
- **AF-1:** Файл со ставками не загружен → оператор извиняется, переводит звонок на внутренний кол-центр
- **AF-2:** Файл со ставками устарел (> 48 часов) → система показывает предупреждение, оператор переводит на внутренний кол-центр
- **AF-3:** Клиент просит создать заявку → оператор переводит звонок на внутренний кол-центр

---

### UC-3: Обновление ставок в системе кол-центра банка

**Акторы:** Rate Management Service (система), Система кол-центра

**Предусловия:**
- Rate Management Service функционирует
- Система кол-центра имеет API для получения ставок
- Ставки обновлены в Rate Management Service

**Main Flow:**
1. Сотрудник бэк-офиса кредитов обновляет ставки в Rate Management Service (ежедневно)
2. Rate Management Service валидирует и сохраняет новые ставки
3. Rate Management Service публикует событие "Ставки обновлены"
4. Система кол-центра получает уведомление (webhook / polling)
5. Система кол-центра вызывает API Rate Management Service: GET /api/v1/rates
6. Rate Management Service возвращает актуальные ставки в JSON
7. Система кол-центра сохраняет ставки в свою БД
8. Система кол-центра помечает ставки как актуальные (timestamp)
9. Операторы видят обновлённые ставки

**Alternative Flows:**
- **AF-1:** Ошибка вызова API → система кол-центра повторяет попытку через 5 минут (до 3 раз)
- **AF-2:** После 3 неудачных попыток → система отправляет alert администратору
- **AF-3:** Невалидные данные в ответе API → система логирует ошибку, не обновляет ставки, alert

---

### UC-4: Передача ставок в партнёрский кол-центр через SFTP

**Акторы:** Rate Management Service (система), Партнёрский кол-центр (система)

**Предусловия:**
- Rate Management Service имеет модуль экспорта в файл
- SFTP-сервер партнёрского кол-центра доступен
- Настроена аутентификация (SSH-ключ)

**Main Flow:**
1. Сотрудник бэк-офиса кредитов обновляет ставки в Rate Management Service (ежедневно)
2. Rate Management Service валидирует и сохраняет новые ставки
3. Rate Management Service формирует файл со ставками:
   - Формат: CSV или Excel
   - Название: `deposit_rates_YYYYMMDD.csv`
   - Структура: ProductID, ProductName, Rate, Term, MinAmount, MaxAmount, UpdatedAt
4. Rate Management Service подключается к SFTP-серверу партнёрского кол-центра
5. Rate Management Service загружает файл в директорию `/incoming/rates/`
6. Партнёрский кол-центр получает файл (polling каждые 15 минут)
7. Партнёрский кол-центр импортирует данные в свою систему
8. Операторы партнёрского кол-центра видят обновлённые ставки

**Alternative Flows:**
- **AF-1:** SFTP-сервер недоступен → Rate Management Service повторяет попытку через 30 минут (до 5 раз)
- **AF-2:** После 5 неудачных попыток → система отправляет alert администратору и бизнесу
- **AF-3:** Партнёр не забрал файл > 24 часов → alert администратору
- **AF-4:** Ошибка формирования файла → логирование, alert, ручная выгрузка

---

## Функциональные требования

### Система кол-центра банка:
- Интерфейс просмотра актуальных ставок депозитов
- Поиск и фильтрация продуктов (по сроку, сумме)
- Отображение timestamp обновления ставок
- Предупреждение при устаревших ставках (> 24 часа)
- API для получения ставок из Rate Management Service
- Webhook для уведомлений об обновлении ставок

### Rate Management Service (дополнения):
- API endpoint для системы кол-центра: GET /api/v1/rates
- Webhook-уведомления при обновлении ставок
- Модуль экспорта ставок в файл (CSV/Excel)
- SFTP-клиент для загрузки файлов в партнёрский кол-центр
- Расписание экспорта (cron: ежедневно после обновления ставок)
- Мониторинг успешности передачи файлов
- Логирование всех операций экспорта

### Партнёрский кол-центр (требования к интеграции):
- SFTP-сервер для приёма файлов
- Импорт CSV/Excel в свою систему
- Отображение ставок операторам
- Предупреждение при устаревших ставках (> 48 часов)

---

## Нефункциональные требования

### Производительность:
- Обновление ставок в системе кол-центра: < 5 минут после публикации
- Загрузка файла в партнёрский кол-центр: < 10 минут после публикации
- API Response time: < 200 мс (GET /api/v1/rates из кэша)

### Надёжность:
- Retry механизм для API-вызовов (3 попытки, exponential backoff)
- Retry механизм для SFTP (5 попыток)
- Alerting при неудачах
- Валидация данных перед экспортом
- Идемпотентность операций

### Безопасность:
- API аутентификация через API Key (для системы кол-центра)
- SFTP аутентификация через SSH-ключ (для партнёрского кол-центра)
- Шифрование файлов (опционально, если партнёр поддерживает)
- IP whitelist для SFTP
- Логирование всех обращений к ставкам

### Поддерживаемость:
- Логирование всех операций экспорта/импорта
- Мониторинг (Grafana dashboards):
  - Количество успешных/неудачных экспортов
  - Время последнего обновления ставок в каждой системе
  - Размер файлов, время загрузки
- Документация API и формата файлов
- Алерты в Slack/Email при проблемах

---

## Решение

### Архитектурный подход

Расширение существующего **Rate Management Service** двумя модулями:
1. **API Integration Module** - для системы кол-центра банка (pull-модель)
2. **File Export Module** - для партнёрского кол-центра (push-модель через SFTP)

### Ключевые компоненты решения:

#### 1. **Rate Management Service - API Integration Module** (расширение)
- **Новый endpoint:** `GET /api/v1/rates`
  - Возвращает все актуальные ставки
  - Кэшируется в Redis (TTL: 15 минут)
  - Поддерживает фильтрацию: `?productType=deposit&term=12`
- **Новый endpoint:** `POST /api/v1/webhooks/subscribe`
  - Регистрация webhook для уведомлений об обновлении
- **Webhook Notification:**
  - При обновлении ставок отправляет POST в зарегистрированные webhooks
  - Payload: `{event: "rates.updated", timestamp: "...", ratesUrl: "/api/v1/rates"}`
- **API Key Authentication:**
  - Система кол-центра получает API Key
  - Валидация через header: `X-API-Key: <key>`

#### 2. **Rate Management Service - File Export Module** (новый модуль)
- **Компонент:** Spring Batch Job / Scheduled Task
- **Технологии:** Spring Integration SFTP, Apache POI (для Excel)
- **Функции:**
  - Экспорт ставок в CSV/Excel после обновления
  - SFTP-клиент для загрузки файлов
  - Retry-логика (5 попыток, exponential backoff)
  - Логирование результатов в БД (таблица `export_logs`)
  - Мониторинг метрик (Prometheus)
- **Расписание:**
  - Triggered событием "Ставки обновлены" + fallback cron (ежедневно 09:00, 15:00)
- **Формат файла (CSV):**
```csv
ProductID,ProductName,Rate,TermMonths,MinAmount,MaxAmount,Currency,UpdatedAt
DEP001,Классический депозит,8.5,12,10000,5000000,RUB,2025-11-24T09:00:00Z
DEP002,Накопительный счёт,7.0,0,1000,null,RUB,2025-11-24T09:00:00Z
```

#### 3. **Система кол-центра - Rates Integration Adapter** (новый компонент)
- **Технологии:** Java Spring Boot (уже используется в системе кол-центра)
- **Функции:**
  - Webhook-приёмник для уведомлений от Rate Management Service
  - HTTP-клиент для вызова API Rate Management Service
  - Сохранение ставок в БД системы кол-центра (таблица `deposit_rates_cache`)
  - Scheduled task для периодического обновления (каждые 60 минут, fallback)
  - Логирование и мониторинг
- **Интерфейс для операторов:**
  - Новая страница "Депозиты" в веб-интерфейсе системы кол-центра (React.js)
  - Таблица продуктов с ставками, сроками, суммами
  - Фильтры: по сроку, сумме, типу продукта
  - Индикатор актуальности (зелёный/жёлтый/красный)

#### 4. **SFTP Infrastructure** (настройка)
- **SFTP-сервер партнёрского кол-центра:**
  - Предоставлен партнёром
  - IP: `sftp.partner-callcenter.com`
  - Порт: 22
  - Аутентификация: SSH private key
  - Директория входящих файлов: `/incoming/rates/`
- **Rate Management Service конфигурация:**
  - Spring Integration SFTP Outbound Adapter
  - Хранение SSH-ключа в секретном хранилище (Vault / Kubernetes Secrets)
  - Retry policy: 5 попыток с задержками 30, 60, 120, 240, 480 минут

#### 5. **Мониторинг и Alerting**
- **Grafana Dashboard "Rates Distribution":**
  - Время последнего обновления ставок в каждой системе
  - Количество успешных/неудачных API-вызовов (кол-центр)
  - Количество успешных/неудачных SFTP-загрузок (партнёр)
  - Размер файлов, время передачи
- **Алерты:**
  - Ставки не обновлены > 25 часов → alert в Slack
  - 3+ неудачных попытки API в системе кол-центра → alert
  - 5 неудачных попыток SFTP → alert + эскалация бизнесу
  - Партнёр не забрал файл > 48 часов → alert

### Диаграммы

См. файлы:
- `C4_Context_CallCenter_Rates.md` - диаграмма контекста (расширенная)
- `C4_Container_CallCenter_Rates.md` - диаграмма контейнеров (фокус на новых компонентах)

### Поток данных:

#### Поток 1: Обновление ставок в системе кол-центра банка (pull + webhook)
```
Сотрудник бэк-офиса кредитов
  → Rate Management Service UI (обновление ставок)
  → Rate Management Service → Rates DB
  → Rate Management Service публикует событие "rates.updated"
  → Webhook → Система кол-центра (Rates Integration Adapter)
  → Rates Integration Adapter → Rate Management Service API: GET /api/v1/rates
  → Rate Management Service → Redis Cache (или Rates DB)
  → Rate Management Service → Rates Integration Adapter (JSON ответ)
  → Rates Integration Adapter → БД системы кол-центра (deposit_rates_cache)
  → Оператор открывает страницу "Депозиты"
  → Веб-интерфейс системы кол-центра → deposit_rates_cache
  → Оператор видит актуальные ставки
```

#### Поток 2: Передача ставок в партнёрский кол-центр (push через SFTP)
```
Сотрудник бэк-офиса кредитов
  → Rate Management Service UI (обновление ставок)
  → Rate Management Service → Rates DB
  → Rate Management Service → File Export Module (triggered event)
  → File Export Module → Rates DB (чтение данных)
  → File Export Module генерирует CSV-файл: deposit_rates_YYYYMMDD.csv
  → File Export Module → SFTP-клиент
  → SFTP-клиент → SFTP-сервер партнёрского кол-центра (загрузка файла)
  → SFTP-сервер → Партнёрский кол-центр (polling каждые 15 мин)
  → Партнёрский кол-центр импортирует данные в свою систему
  → Оператор партнёрского кол-центра видит актуальные ставки
```

---

## Альтернативы

### Альтернатива 1: Push-модель для системы кол-центра банка (через Kafka)
**Описание:** Использовать Kafka для push-уведомлений вместо API pull + webhook

**Преимущества:**
- Более надёжная доставка
- Меньше нагрузки на Rate Management Service (не нужно обслуживать API)
- Unified архитектура (Kafka уже используется для заявок)

**Недостатки:**
- Система кол-центра должна интегрироваться с Kafka (дополнительная разработка)
- Усложнение архитектуры системы кол-центра
- Команда подрядчика системы кол-центра может не иметь опыта с Kafka

**Решение:** Отклонено для MVP. HTTP API проще и быстрее реализовать. Kafka - для будущей оптимизации.

### Альтернатива 2: Email-рассылка файлов в партнёрский кол-центр
**Описание:** Отправлять файлы со ставками по email вместо SFTP

**Преимущества:**
- Не требуется настройка SFTP
- Простота реализации (SMTP)
- Меньше технических требований к партнёру

**Недостатки:**
- Меньшая надёжность (email может попасть в спам, задержки)
- Сложность автоматизации на стороне партнёра (ручное скачивание вложений)
- Проблемы безопасности (email не зашифрован, если не PGP)
- Невозможность автоматического retry

**Решение:** Отклонено. SFTP более надёжен и автоматизируем.

### Альтернатива 3: Предоставить партнёру доступ к API Rate Management Service
**Описание:** Дать партнёрскому кол-центру API Key для прямого доступа к API

**Преимущества:**
- Real-time данные
- Не нужен File Export Module
- Проще поддержка

**Недостатки:**
- Партнёр сообщил, что может работать только с файлами (техническое ограничение их системы)
- Безопасность: внешний доступ к API банка
- Зависимость от доступности API для внешней системы

**Решение:** Отклонено из-за технического ограничения партнёра (нет возможности API-интеграции).

---

## Последствия

### Положительные:
+ Операторы кол-центра смогут консультировать клиентов по актуальным ставкам
+ Снижение нагрузки на внутренний кол-центр (подключение партнёра)
+ Улучшение качества обслуживания клиентов
+ Автоматизация передачи ставок (замена ручного Excel)
+ Прозрачность: мониторинг актуальности ставок в каждой системе
+ Масштабируемость: легко добавить новые каналы потребления ставок

### Отрицательные:
- Усложнение Rate Management Service (2 новых модуля)
- Необходимость разработки в системе кол-центра (Rates Integration Adapter)
- Зависимость от SFTP-сервера партнёра (внешняя система)
- Задержка обновления в партнёрском кол-центре (до 25 минут: экспорт 10 мин + polling 15 мин)
- Необходимость мониторинга и поддержки интеграций

### Риски:
**Риск 1:** SFTP-сервер партнёра недоступен или нестабилен
- *Митигация:* Retry-механизм (5 попыток), алерты, SLA с партнёром на доступность SFTP

**Риск 2:** Партнёр неправильно импортирует файл (ошибки парсинга)
- *Митигация:* Стандартизированный формат (CSV с header), документация, тестирование с партнёром

**Риск 3:** Устаревшие ставки в партнёрском кол-центре (если файл не доставлен)
- *Митигация:* Alerting при неудаче доставки, предупреждение операторам при ставках > 48 часов

**Риск 4:** Перегрузка API Rate Management Service запросами от системы кол-центра
- *Митигация:* Кэширование (Redis), rate limiting, scheduled updates (не чаще 1 раза в час)

---

## Зависимости

- **Зависит от:** Rate Management Service (Task 3, должен быть готов)
- **Блокирует:** Запуск маркетинговой кампании (нельзя запускать без готовности кол-центра)
- **Параллельно:** Может разрабатываться параллельно с Deposit Application Service

---

## Метрики успеха

- Актуальность ставок в системе кол-центра: > 95% времени (задержка < 10 минут)
- Актуальность ставок у партнёра: > 90% времени (задержка < 30 минут)
- Успешность SFTP-передач: > 98%
- Успешность API-вызовов системы кол-центра: > 99.5%
- Время консультации клиента оператором (со ставками): сокращение на 30% vs без ставок
- Конверсия звонок → заявка: > 15% (после доступности ставок)

---

## Следующие шаги

1. Разработка API Integration Module в Rate Management Service (1 неделя)
2. Разработка File Export Module в Rate Management Service (1.5 недели)
3. Настройка SFTP-инфраструктуры с партнёром (2 недели, параллельно)
4. Разработка Rates Integration Adapter в системе кол-центра (2 недели)
5. Разработка UI для операторов в системе кол-центра (1.5 недели)
6. Тестирование интеграций (1 неделя)
7. Обучение операторов (внутренний и партнёрский кол-центры) (1 неделя)
8. Запуск в продакшен

**Критический путь:** SFTP-настройка с партнёром (зависит от партнёра, может затянуться)

# ADR: Онлайн подача заявок на кредит

**Статус:** Принято
**Дата:** 2025-11-24
**Авторы:** Команда цифровой трансформации
**Связан с:** ADR "Онлайн открытие депозитов (MVP)"

---

## Контекст

После успешного запуска MVP для онлайн-депозитов, банк "Стандарт" планирует расширить онлайн-функциональность на кредитные продукты. Текущий процесс кредитования требует личного визита в отделение и занимает до недели.

### Текущая ситуация:
- Клиент может подать заявку на кредит только в отделении
- Заявки попадают в АБС, затем раз в день передаются в Кредитный конвейер
- Обработка заявки занимает несколько дней (до недели)
- Скоринг вызывается вручную сотрудником бэк-офиса
- Нет предодобренных предложений для клиентов
- Новые клиенты не могут получить кредит без визита в отделение

### Бизнес-цели:
**Целевое состояние (12 месяцев после MVP депозитов):**
- Клиенты видят предодобренные кредитные предложения в интернет-банке
- Клиенты могут подать заявку на кредит в интернет-банке и на сайте
- Заявки по предодобренным предложениям обрабатываются в течение рабочего дня (вместо недели)
- Новые клиенты на сайте получают мгновенное решение (через БКИ)

---

## Use Cases

### UC-1: Просмотр предодобренного кредитного предложения (интернет-банк)

**Акторы:** Клиент банка (авторизованный)

**Предусловия:**
- Клиент авторизован в интернет-банке
- Система скоринга рассчитала предодобренное предложение для клиента (batch-процесс, ежедневно)

**Main Flow (Happy Path):**
1. Клиент открывает раздел "Кредиты" в интернет-банке
2. Система запрашивает предодобренные предложения у Credit Application Service
3. Credit Application Service возвращает список предодобренных предложений (если есть)
4. Клиент видит баннер с предодобренным предложением:
   - "Одобрено до X рублей под Y% годовых"
   - "Решение за 1 день"
5. Система также отображает список доступных кредитных продуктов с общими условиями
6. Клиент может выбрать:
   - Подать заявку на предодобренное предложение (UC-2)
   - Посмотреть условия обычных кредитов
   - Выйти из раздела

**Alternative Flows:**
- **AF-1:** У клиента нет предодобренных предложений → отображаются только общие кредитные продукты
- **AF-2:** Предодобренное предложение устарело (> 30 дней) → система не отображает его
- **AF-3:** Клиент уже подал заявку по этому предложению → отображается статус существующей заявки

---

### UC-2: Подача заявки на кредит по предодобренному предложению (интернет-банк)

**Акторы:** Клиент банка (авторизованный), Сотрудник бэк-офиса кредитов

**Предусловия:**
- Клиент авторизован в интернет-банке
- У клиента есть активное предодобренное предложение
- У клиента есть счета для зачисления

**Main Flow (Happy Path):**
1. Клиент выбирает предодобренное предложение
2. Система отображает форму заявки:
   - Сумма кредита (предзаполнена, можно изменить в пределах лимита)
   - Срок кредита (dropdown: 12, 24, 36 месяцев)
   - Счёт зачисления средств (dropdown)
   - Цель кредита (текстовое поле, опционально)
3. Клиент заполняет форму
4. Система отображает итоговые условия:
   - Ежемесячный платёж
   - Полная стоимость кредита
   - Ставка, срок
5. Клиент нажимает "Подать заявку"
6. Система запрашивает СМС-код для подтверждения
7. Клиент вводит СМС-код
8. Система валидирует СМС-код
9. Система создаёт заявку в Credit Application Service
10. Credit Application Service:
    - Сохраняет заявку в БД (status: 'CREATED')
    - Помечает заявку как "Предодобренная" (флаг pre_approved: true)
    - Публикует заявку в Kafka (топик: credit-applications)
11. Клиент видит сообщение: "Заявка принята. Решение в течение рабочего дня"
12. Клиент перенаправляется на страницу со статусом заявки
13. Kafka → Кредитный конвейер Integration Adapter → Кредитный конвейер
14. Заявка попадает в очередь с высоким приоритетом (предодобренная)
15. Сотрудник бэк-офиса кредитов видит заявку в Кредитном конвейере
16. Кредитный конвейер автоматически вызывает систему скоринга (REST API)
17. Система скоринга возвращает результат (скоринг уже рассчитан, актуален)
18. Сотрудник проверяет заявку и одобряет её
19. Кредитный конвейер → Kafka → Credit Application Service: status = 'APPROVED'
20. Credit Application Service обновляет статус в БД
21. Кредитный конвейер → АБС (через интеграцию): зачисление средств на счёт
22. АБС → СМС-шлюз → Клиент: "Кредит одобрен, средства зачислены"
23. Клиент видит обновлённый статус в интернет-банке: "Одобрено"

**Alternative Flows:**
- **AF-1:** Неверный СМС-код (1-2 попытка) → система предлагает повторить ввод
- **AF-2:** Неверный СМС-код (3 попытка) → операция блокируется на N минут
- **AF-3:** Сумма кредита превышает предодобренный лимит → система показывает ошибку валидации
- **AF-4:** Таймаут ввода СМС-кода → операция отменяется
- **AF-5:** Сотрудник отклоняет заявку (риски, несоответствие данным) → статус = 'REJECTED', СМС клиенту с причиной
- **AF-6:** Система скоринга вернула отрицательный результат (изменились данные) → заявка отклоняется автоматически или требует ручного решения
- **AF-7:** Сбой при публикации в Kafka → заявка сохраняется в очередь retry, клиент видит статус "В обработке"

---

### UC-3: Подача заявки на кредит без предодобрения (интернет-банк)

**Акторы:** Клиент банка (авторизованный), Сотрудник бэк-офиса кредитов

**Предусловия:**
- Клиент авторизован в интернет-банке
- У клиента НЕТ предодобренного предложения или он выбрал другой продукт

**Main Flow (Happy Path):**
1. Клиент выбирает кредитный продукт из каталога
2. Система отображает форму заявки:
   - Сумма кредита (ввод вручную, мин/макс лимиты)
   - Срок кредита (dropdown)
   - Счёт зачисления
   - Дополнительная информация (цель, доход, место работы)
3. Клиент заполняет форму
4. Система отображает предварительные условия (ставка может измениться после скоринга)
5. Клиент подтверждает через СМС-код (как в UC-2, шаги 6-8)
6. Система создаёт заявку в Credit Application Service (pre_approved: false)
7. Credit Application Service публикует заявку в Kafka
8. Клиент видит: "Заявка принята. Решение в течение 3 рабочих дней"
9. Кредитный конвейер получает заявку (обычный приоритет)
10. Сотрудник бэк-офиса обрабатывает заявку:
    - Проверяет данные клиента
    - Вызывает скоринг (REST API)
    - Анализирует результат скоринга
    - Принимает решение (одобрить/отклонить)
11. Если одобрено:
    - Кредитный конвейер → Kafka → Credit Application Service: status = 'APPROVED'
    - АБС зачисляет средства
    - СМС клиенту: "Кредит одобрен"
12. Если отклонено:
    - Кредитный конвейер → Kafka → Credit Application Service: status = 'REJECTED'
    - СМС клиенту: "Заявка отклонена" (причина)

**Alternative Flows:**
- **AF-1:** Недостаточно данных для скоринга → сотрудник запрашивает дополнительные документы, заявка переходит в статус 'AWAITING_DOCUMENTS'
- **AF-2:** Скоринг вернул пограничный результат → эскалация руководителю бэк-офиса
- **AF-3:** Клиент запросил сумму выше лимитов по продукту → система показывает ошибку валидации

---

### UC-4: Подача заявки на кредит новым клиентом (сайт)

**Акторы:** Новый клиент (не клиент банка), Сотрудник бэк-офиса кредитов

**Предусловия:**
- Клиент зашёл на сайт банка
- Клиент НЕ является клиентом банка

**Main Flow (Happy Path):**
1. Клиент открывает страницу "Кредиты" на сайте
2. Система отображает список кредитных продуктов с условиями
3. Клиент выбирает продукт
4. Система отображает форму заявки:
   - ФИО
   - Номер телефона
   - Сумма кредита
   - Срок кредита
   - **Опционально: паспортные данные (серия, номер, дата выдачи)**
5. Клиент заполняет форму (включая паспортные данные)
6. Клиент нажимает "Подать заявку"
7. Система валидирует данные
8. Система отправляет запрос в Credit Application Service
9. Credit Application Service:
    - Сохраняет заявку (status: 'CREATED', source: 'WEBSITE', client_type: 'NEW')
    - Если паспортные данные указаны:
      a. Вызывает систему скоринга (REST API)
      b. Система скоринга запрашивает БКИ (REST API, онлайн)
      c. БКИ возвращает кредитную историю
      d. Система скоринга рассчитывает скоринг (только на основе БКИ, т.к. клиент новый)
      e. Система скоринга возвращает результат: APPROVED / REJECTED с суммой лимита
    - Если паспортных данных нет: скоринг не вызывается
10. Credit Application Service возвращает результат на сайт
11a. Если скоринг был вызван и результат APPROVED:
    - Клиент видит: "Поздравляем! Кредит одобрен до X рублей"
    - "Приходите в отделение для получения кредита с паспортом"
    - СМС клиенту с адресом ближайшего отделения
11b. Если скоринг был вызван и результат REJECTED:
    - Клиент видит: "К сожалению, мы не можем одобрить кредит"
11c. Если скоринг НЕ был вызван (нет паспортных данных):
    - Клиент видит: "Заявка принята. С вами свяжется менеджер"
    - СМС клиенту: "Заявка принята"
    - Заявка публикуется в Kafka → попадает в Кредитный конвейер
    - Сотрудник бэк-офиса связывается с клиентом, запрашивает документы
12. Если клиент приходит в отделение:
    - Менеджер находит заявку в АБС (по ФИО, телефону)
    - Менеджер идентифицирует клиента (проверка паспорта)
    - Менеджер продолжает работу с заявкой (статус → 'IN_PROGRESS')
    - После одобрения: открывается счёт, зачисляются средства

**Alternative Flows:**
- **AF-1:** Паспортные данные некорректны → система показывает ошибку валидации
- **AF-2:** БКИ недоступно (таймаут) → система сохраняет заявку без мгновенного решения, СМС "С вами свяжется менеджер"
- **AF-3:** Клиент не приходит в отделение > N дней → заявка аннулируется
- **AF-4:** Клиент уже является клиентом банка (обнаружено при проверке паспорта в отделении) → заявка переносится в систему для существующих клиентов

---

### UC-5: Предрасчёт предодобренных предложений (batch-процесс)

**Акторы:** Система скоринга (автоматический процесс)

**Предусловия:**
- Система скоринга функционирует
- Есть актуальные данные клиентов из АБС (синхронизация раз в сутки)

**Main Flow (Happy Path):**
1. Система скоринга запускает batch-процесс (ежедневно, ночью, 02:00)
2. Система скоринга читает список всех активных клиентов банка из БД (данные из АБС)
3. Для каждого клиента:
   a. Система скоринга рассчитывает скоринг на основе:
      - Данных клиента в АБС (доходы, расходы, текущие кредиты/депозиты)
      - Истории платежей по кредитам (АБС)
      - Кредитной истории (БКИ, кэшированные данные за последние 30 дней)
   b. Если скоринг > порог:
      - Система рассчитывает предодобренную сумму и ставку
      - Система сохраняет предложение в БД (таблица pre_approved_offers)
      - Срок действия: 30 дней
   c. Если скоринг < порог:
      - Предложение не создаётся (или удаляется старое)
4. Система скоринга логирует результаты batch-процесса:
   - Количество обработанных клиентов
   - Количество созданных предложений
   - Количество отклонённых
5. Система скоринга отправляет метрики в Prometheus

**Alternative Flows:**
- **AF-1:** Данные клиента неполные → клиент пропускается, логируется warning
- **AF-2:** БКИ недоступно → используются кэшированные данные (если < 30 дней), иначе клиент пропускается
- **AF-3:** Batch-процесс не завершился до утра (06:00) → процесс останавливается, отправляется alert

---

## Функциональные требования

### Интернет-банк (дополнения к Task 3):
- Раздел "Кредиты" с отображением кредитных продуктов
- Отображение предодобренных кредитных предложений (баннер/карточка)
- Форма подачи заявки на кредит:
  - Для предодобренных предложений (упрощённая)
  - Для обычных кредитов (полная)
- Подтверждение через СМС-код
- Раздел "Мои заявки на кредиты" с отображением статусов
- Polling/WebSocket для обновления статусов в реальном времени

### Сайт (дополнения к Task 4):
- Страница "Кредиты" с каталогом продуктов
- Форма подачи заявки для новых клиентов:
  - ФИО, телефон, сумма, срок
  - Опционально: паспортные данные
- Мгновенное решение при указании паспортных данных
- Страница с результатом (одобрено/не одобрено/свяжемся)
- HTTPS/TLS

### Credit Application Service (новый микросервис):
- REST API для создания заявок на кредит:
  - POST /api/v1/credit-applications
- REST API для получения статусов:
  - GET /api/v1/credit-applications/{id}
  - GET /api/v1/credit-applications (список заявок)
- REST API для получения предодобренных предложений:
  - GET /api/v1/pre-approved-offers/{clientId}
- Интеграция с системой скоринга (REST API):
  - Для новых клиентов с сайта (через БКИ)
- Kafka Producer: публикация заявок в топик 'credit-applications'
- Kafka Consumer: чтение статусов из топика 'credit-application-status'
- Управление статусами заявок (state machine)
- Идемпотентность операций
- Аудит всех операций

### Система скоринга (дополнения):
- REST API для мгновенного скоринга новых клиентов:
  - POST /api/v1/scoring/instant (через БКИ)
- Batch-процесс предрасчёта предодобренных предложений:
  - Ежедневный запуск (ночью)
  - Обработка всех клиентов банка
  - Сохранение результатов в БД (pre_approved_offers)
- REST API для получения предодобренных предложений:
  - GET /api/v1/scoring/pre-approved/{clientId}
- Кэширование данных БКИ (30 дней)

### Кредитный конвейер (доработки):
- Изменение интеграции с АБС:
  - Вместо раз в день → в режиме реального времени (через Kafka)
- Приоритизация заявок:
  - Предодобренные заявки → высокий приоритет
  - Обычные заявки → стандартный приоритет
- Автоматический вызов скоринга для всех заявок (REST API)
- Kafka Producer: публикация статусов в топик 'credit-application-status'
- Интерфейс для сотрудников бэк-офиса с отображением приоритета заявок

### АБС (доработки):
- Приём заявок из Кредитного конвейера в реальном времени (через Kafka)
- Интерфейс для менеджеров отделений:
  - Поиск заявок новых клиентов (по ФИО, телефону)
  - Продолжение работы с заявкой после идентификации клиента
- СМС-уведомления при изменении статуса кредитной заявки

---

## Нефункциональные и архитектурно-значимые требования

### Производительность:
- Мгновенное решение для новых клиентов: < 5 секунд (зависит от БКИ)
- Обработка предодобренных заявок: < 1 рабочий день (8 часов)
- Batch-процесс предрасчёта: завершение до 06:00 (4 часа на 100K клиентов)
- Отклик API Credit Application Service: < 200 мс
- Система скоринга не должна быть перегружена дополнительными запросами:
  - Batch-процесс запускается ночью (низкая нагрузка)
  - Мгновенный скоринг для новых клиентов: ограничение rate limiting (50 req/min)

### Надёжность:
- Доступность 24/7, 99.9%
- Шифрование трафика (HTTPS/TLS)
- СМС-подтверждение для всех операций
- Идемпотентность операций (защита от дублей)
- Retry-механизмы для интеграций (Kafka, REST API)
- Fallback при недоступности БКИ:
  - Для новых клиентов: сохранить заявку без мгновенного решения
  - Для batch-процесса: использовать кэшированные данные (< 30 дней)

### Масштабируемость:
- Горизонтальное масштабирование Credit Application Service (2-6 инстансов)
- Горизонтальное масштабирование системы скоринга (уже поддерживается)
- Кредитный конвейер поддерживает горизонтальное масштабирование
- Kafka-кластер: 3-5 брокеров, партиции для параллельной обработки

### Безопасность:
- API Key аутентификация для внешних систем
- Шифрование паспортных данных в БД
- Аудит всех операций с кредитными заявками
- Rate limiting:
  - Credit Application Service API: 100 req/min per IP
  - Система скоринга (instant): 50 req/min (защита от перегрузки)
- Разграничение доступа между бэк-офисом депозитов и кредитов (уже реализовано)

### Поддерживаемость:
- Использование существующих технологий (Java Spring Boot, PostgreSQL, Kafka)
- Логирование всех операций (ELK Stack)
- Мониторинг (Prometheus + Grafana):
  - Количество заявок, конверсия, среднее время обработки
  - Успешность вызовов скоринга, БКИ
  - Batch-процесс: длительность, количество предложений
- Документация API (Swagger/OpenAPI)

---

## Решение

### Архитектурный подход

Расширение существующей микросервисной платформы (из Task 3) новым сервисом для кредитов:
1. **Credit Application Service** - управление кредитными заявками (аналогично Deposit Application Service)
2. **Доработка системы скоринга** - batch-процесс предрасчёта, API для мгновенного скоринга
3. **Интеграция через Kafka** - реальное время вместо раз в день
4. **Приоритизация заявок** - предодобренные обрабатываются быстрее

### Ключевые компоненты решения:

#### 1. **Credit Application Service** (новый микросервис)
- **Технологии:** Java Spring Boot 2.7, PostgreSQL 14
- **Функции:**
  - Приём заявок из всех каналов (интернет-банк, сайт, отделение)
  - Управление статусами заявок
  - Интеграция с системой скоринга (REST API)
  - Kafka Producer (публикация заявок)
  - Kafka Consumer (чтение статусов)
  - API для получения предодобренных предложений
- **База данных:** Credit Applications DB (PostgreSQL)
  - Таблицы: credit_applications, application_status_history, audit_log
- **Порты:** 8083 (HTTP internal)

#### 2. **Система скоринга - Pre-Approved Offers Module** (расширение)
- **Технологии:** Python, Flask, PostgreSQL
- **Функции:**
  - Batch-процесс предрасчёта (ежедневно, ночью):
    - Обработка всех клиентов банка
    - Расчёт скоринга на основе АБС + БКИ (кэш)
    - Сохранение предложений в pre_approved_offers
  - REST API для instant scoring (новые клиенты):
    - POST /api/v1/scoring/instant
    - Только через БКИ (клиент новый)
  - REST API для получения предодобренных предложений:
    - GET /api/v1/scoring/pre-approved/{clientId}
- **Scheduler:** Cron (ежедневно в 02:00)
- **БД:** Новая таблица pre_approved_offers в PostgreSQL

#### 3. **Кредитный конвейер Integration Adapter** (новый компонент)
- **Технологии:** Java Spring Boot (у команды Кредитного конвейера есть опыт)
- **Функции:**
  - Kafka Consumer: чтение заявок из топика 'credit-applications'
  - Запись заявок в БД Кредитного конвейера (Oracle)
  - Приоритизация заявок (pre_approved: true → высокий приоритет)
  - Kafka Producer: публикация статусов в топик 'credit-application-status'
- **Развёртывание:** На серверах Кредитного конвейера

#### 4. **Kafka Cluster** (расширение)
- **Новые топики:**
  - `credit-applications` - заявки на кредиты
  - `credit-application-status` - статусы заявок
- **Конфигурация:**
  - Партиции: 10
  - Replication factor: 2

#### 5. **Доработки существующих систем:**

**Интернет-банк:**
- Страница "Кредиты" с предодобренными предложениями
- Формы подачи заявок
- Раздел "Мои заявки на кредиты"
- HTTP-клиент для Credit Application Service

**Сайт:**
- Страница "Кредиты"
- Форма заявки с опциональными паспортными данными
- Мгновенное решение (если паспорт указан)

**Кредитный конвейер:**
- Интерфейс с индикатором приоритета заявок
- Автоматический вызов скоринга (REST API)

**АБС:**
- Интерфейс для менеджеров отделений (поиск заявок новых клиентов)

### Диаграммы

См. файлы:
- `C4_Context_Credits.md` - диаграмма контекста
- `C4_Container_Credits.md` - диаграмма контейнеров

### Потоки данных:

#### Поток 1: Предодобренная заявка из интернет-банка
```
Batch-процесс (ночью):
  Система скоринга → АБС (данные клиентов, раз в сутки)
  Система скоринга → БКИ (кэш, 30 дней)
  Система скоринга рассчитывает скоринг для всех клиентов
  Система скоринга → pre_approved_offers (сохранение предложений)

Клиент → Интернет-банк (открывает "Кредиты")
  Интернет-банк → Credit Application Service: GET /pre-approved-offers/{clientId}
  Credit Application Service → Система скоринга: GET /pre-approved/{clientId}
  Система скоринга → Credit Application Service (предложение)
  Credit Application Service → Интернет-банк (предложение)
  Клиент видит предодобренное предложение

Клиент → Интернет-банк (подаёт заявку)
  Интернет-банк → Credit Application Service: POST /credit-applications
  Credit Application Service → Credit Applications DB (сохранение)
  Credit Application Service → Kafka (публикация, pre_approved: true)
  Kafka → Кредитный конвейер Integration Adapter
  Кредитный конвейер Integration Adapter → Кредитный конвейер БД (высокий приоритет)
  Сотрудник бэк-офиса → Кредитный конвейер (обработка)
  Кредитный конвейер → Система скоринга (REST API, подтверждение актуальности)
  Система скоринга → Кредитный конвейер (результат)
  Сотрудник одобряет заявку
  Кредитный конвейер → Kafka (статус: APPROVED)
  Kafka → Credit Application Service (обновление статуса)
  Кредитный конвейер → АБС (зачисление средств)
  АБС → СМС-шлюз → Клиент (СМС)
  Клиент → Интернет-банк (видит статус "Одобрено")
```

#### Поток 2: Новый клиент с сайта (мгновенное решение)
```
Клиент → Сайт (заполняет форму с паспортными данными)
  Сайт → Credit Application Service: POST /credit-applications (с паспортом)
  Credit Application Service → Система скоринга: POST /scoring/instant
  Система скоринга → БКИ (REST API, запрос кредитной истории)
  БКИ → Система скоринга (кредитная история)
  Система скоринга рассчитывает скоринг (только БКИ, т.к. клиент новый)
  Система скоринга → Credit Application Service (результат: APPROVED/REJECTED, сумма лимита)
  Credit Application Service → Сайт (результат)
  Клиент видит: "Одобрено до X рублей" или "Не одобрено"
  СМС клиенту с адресом отделения

Клиент приходит в отделение
  Менеджер → АБС (поиск заявки по ФИО, телефону)
  Менеджер идентифицирует клиента (паспорт)
  Менеджер → АБС (продолжение работы с заявкой)
  АБС → Открытие счёта, зачисление средств
```

---

## Альтернативы

### Альтернатива 1: Полностью автоматическое одобрение кредитов

**Описание:** Убрать ручную обработку заявок сотрудниками, полностью автоматизировать решение на основе скоринга.

**Преимущества:**
- Мгновенное решение для всех клиентов (не только новых)
- Снижение операционных издержек (не нужен бэк-офис кредитов)
- Масштабируемость (обработка тысяч заявок без людей)

**Недостатки:**
- Высокие риски кредитных потерь (нет человеческого контроля)
- Необходимость очень точной модели скоринга (требуется обучение на больших данных)
- Невозможность обработки edge cases (нестандартные ситуации)
- Регуляторные требования могут запрещать полную автоматизацию
- Бизнес не готов к такому уровню автоматизации (требуется постепенный переход)

**Решение:** Отклонено для данного этапа. Рассмотреть для будущих фаз после накопления опыта с предодобренными предложениями.

---

### Альтернатива 2: Синхронная интеграция Кредитный конвейер <-> АБС (REST API вместо Kafka раз в день)

**Описание:** Заменить текущую интеграцию (БД, раз в день) и Kafka на прямые REST API вызовы между системами.

**Преимущества:**
- Упрощение архитектуры (не нужен Kafka для кредитов)
- Синхронность (немедленная передача данных)

**Недостатки:**
- Tight coupling между системами (прямая зависимость)
- Риск перегрузки АБС (прямые вызовы)
- Сложность retry-логики при сбоях
- Нет буферизации нагрузки
- Kafka уже используется для депозитов (unified architecture)

**Решение:** Отклонено. Kafka обеспечивает буферизацию, надёжность и соответствует архитектуре депозитов.

---

### Альтернатива 3: Объединить Credit Application Service и Deposit Application Service в один Application Service

**Описание:** Создать единый микросервис для всех типов заявок (депозиты, кредиты, другие продукты).

**Преимущества:**
- Меньше микросервисов (упрощение инфраструктуры)
- Unified API для всех продуктов
- Общая логика управления заявками

**Недостатки:**
- Coupling разных доменов (депозиты и кредиты имеют разную бизнес-логику)
- Сложность масштабирования (кредиты могут иметь другую нагрузку, чем депозиты)
- Риск: изменения в кредитной логике могут повлиять на депозиты (и наоборот)
- Нарушение принципа Single Responsibility
- Команды депозитов и кредитов разные, сложнее координировать разработку

**Решение:** Отклонено. Лучше держать сервисы разделёнными по доменам (Bounded Contexts в DDD).

---

### Альтернатива 4: Предрасчёт предодобренных предложений в реальном времени (при каждом входе в интернет-банк)

**Описание:** Вместо batch-процесса ночью рассчитывать предложения on-demand при входе клиента.

**Преимущества:**
- Всегда актуальные данные (без задержки до следующего дня)
- Не нужен batch-процесс

**Недостатки:**
- Высокая нагрузка на систему скоринга (тысячи запросов при входе клиентов)
- Высокая нагрузка на БКИ (тысячи запросов, стоимость API-вызовов)
- Увеличение latency при входе в интернет-банк (ожидание расчёта скоринга)
- Риск перегрузки системы в пиковые часы
- БКИ имеет rate limits и может блокировать запросы

**Решение:** Отклонено. Batch-процесс ночью более эффективен и не перегружает системы.

---

### Альтернатива 5: Использовать существующую интеграцию АБС <-> Кредитный конвейер (раз в день через БД)

**Описание:** Не менять текущую интеграцию, оставить передачу заявок раз в день через БД.

**Преимущества:**
- Не требуется разработка Кредитный конвейер Integration Adapter
- Меньше изменений в архитектуре
- Текущая интеграция работает стабильно

**Недостатки:**
- Невозможно обработать заявку в течение рабочего дня (заявка попадёт в конвейер только на следующий день)
- Не выполняется бизнес-требование: "Заявки по предодобренным предложениям обрабатываются в течение рабочего дня"
- Плохой пользовательский опыт (клиент ждёт решения неделю, как раньше)
- Нет конкурентного преимущества (конкуренты дают решение за 1 день)

**Решение:** Отклонено из-за невыполнения ключевого бизнес-требования.

---

## Ограничения решения

### Технические ограничения:

1. **Зависимость от доступности БКИ**
   - **Описание:** Мгновенное решение для новых клиентов зависит от доступности REST API БКИ.
   - **Влияние:** Если БКИ недоступно (таймаут, сбой), клиент не получит мгновенное решение.
   - **Митигация:**
     - Кэширование данных БКИ (30 дней) для batch-процесса
     - Fallback: сохранение заявки без мгновенного решения, СМС "С вами свяжется менеджер"
     - Мониторинг доступности БКИ, SLA с провайдером БКИ

2. **Ограничения системы скоринга**
   - **Описание:** Система скоринга не должна быть перегружена дополнительными запросами.
   - **Влияние:** Нельзя вызывать скоринг слишком часто, есть ограничения производительности.
   - **Митигация:**
     - Batch-процесс запускается ночью (низкая нагрузка)
     - Rate limiting для instant scoring (50 req/min)
     - Горизонтальное масштабирование системы скоринга (уже поддерживается)

3. **Задержка синхронизации данных АБС → Система скоринга**
   - **Описание:** Данные из АБС передаются в систему скоринга раз в сутки.
   - **Влияние:** Предодобренные предложения могут быть основаны на вчерашних данных клиента.
   - **Митигация:**
     - Повторная проверка скоринга при обработке заявки (Кредитный конвейер вызывает скоринг онлайн)
     - Если данные изменились критично → заявка может быть отклонена или перенаправлена на ручное решение

4. **Невозможность полностью автоматического одобрения кредитов**
   - **Описание:** Бизнес требует ручного контроля сотрудников бэк-офиса для всех заявок (кроме мгновенного решения для новых клиентов).
   - **Влияние:** Время обработки заявки зависит от доступности сотрудников (рабочие часы, нагрузка).
   - **Митигация:**
     - Приоритизация предодобренных заявок (обрабатываются в первую очередь)
     - Dashboard для бэк-офиса с метриками (SLA, время обработки)
     - В будущем: рассмотреть частичную автоматизацию для низкорисковых заявок

### Бизнес-ограничения:

5. **Новые клиенты должны приходить в отделение для получения кредита**
   - **Описание:** Банковское законодательство требует личной идентификации новых клиентов.
   - **Влияние:** Невозможно полностью онлайн-процесс для новых клиентов.
   - **Митигация:**
     - Предоставление мгновенного решения онлайн (преимущество)
     - СМС с адресом ближайшего отделения
     - В будущем: рассмотреть удалённую идентификацию (Госуслуги, видеозвонок)

6. **Ограничения предодобренных предложений**
   - **Описание:** Предложения действительны 30 дней, после этого могут устареть.
   - **Влияние:** Клиент может увидеть предложение, которое уже не актуально (если прошло > 30 дней).
   - **Митигация:**
     - Проверка срока действия при отображении предложения
     - Повторный расчёт скоринга при подаче заявки (Кредитный конвейер)
     - Batch-процесс обновляет предложения ежедневно

7. **Обработка в течение рабочего дня (не 24/7)**
   - **Описание:** Сотрудники бэк-офиса работают в рабочие часы (09:00-18:00).
   - **Влияние:** Заявка, поданная вечером или в выходные, будет обработана только в следующий рабочий день.
   - **Митигация:**
     - Информирование клиента о времени обработки: "Решение в течение рабочего дня" (не "в течение дня")
     - СМС-уведомления при изменении статуса (клиент будет в курсе)

### Архитектурные ограничения:

8. **Кредитный конвейер остаётся на Oracle БД**
   - **Описание:** Кредитный конвейер использует Oracle, невозможно быстро мигрировать на PostgreSQL.
   - **Влияние:** Необходимость поддерживать Oracle (лицензии, специалисты).
   - **Митигация:**
     - Кредитный конвейер Integration Adapter изолирует Oracle от других систем
     - Интеграция через Kafka (другие системы не зависят от Oracle)

9. **Постепенная миграция от batch-интеграции к real-time**
   - **Описание:** Текущая интеграция АБС <-> Кредитный конвейер (раз в день) заменяется на Kafka (real-time).
   - **Влияние:** Риск: обе интеграции могут работать параллельно какое-то время (double processing).
   - **Митигация:**
     - Флаг в заявках: source = 'LEGACY' (старая интеграция) vs 'ONLINE' (новая через Kafka)
     - Кредитный конвейер обрабатывает только заявки с source = 'ONLINE'
     - Постепенное отключение старой интеграции после стабилизации новой

10. **Rate limiting на БКИ и система скоринга**
    - **Описание:** БКИ имеет rate limits (например, 1000 запросов/час), стоимость API-вызовов.
    - **Влияние:** Невозможно делать неограниченное количество запросов к БКИ.
    - **Митигация:**
      - Кэширование данных БКИ (30 дней) для batch-процесса
      - Rate limiting для instant scoring (50 req/min)
      - Мониторинг использования квоты БКИ, алерты при приближении к лимиту

---

## Последствия

### Положительные:
- Клиенты получают предодобренные кредитные предложения (улучшение UX)
- Заявки обрабатываются в течение рабочего дня (вместо недели)
- Новые клиенты получают мгновенное решение (конкурентное преимущество)
- Увеличение конверсии (предодобренные предложения повышают вероятность подачи заявки)
- Снижение нагрузки на отделения (меньше визитов для простых кредитов)
- Прозрачность для клиентов (статусы заявок в реальном времени)

### Отрицательные:
- Увеличение нагрузки на систему скоринга (batch-процесс, instant scoring)
- Зависимость от доступности БКИ (для новых клиентов)
- Необходимость разработки и поддержки Credit Application Service
- Изменения в Кредитном конвейере (приоритизация, интеграция)
- Расходы на API-вызовы БКИ (увеличение количества запросов)

### Риски:
- **Риск 1:** БКИ недоступно часто → новые клиенты не получают мгновенное решение, плохой UX
  - *Митигация:* SLA с провайдером БКИ, fallback на ручную обработку, мониторинг
- **Риск 2:** Batch-процесс не завершается вовремя → клиенты не видят предодобренные предложения утром
  - *Митигация:* Оптимизация производительности, параллельная обработка, алерты, начало batch-процесса раньше (01:00 вместо 02:00)
- **Риск 3:** Предодобренное предложение устарело, но клиент подал заявку → отклонение после ожидания
  - *Митигация:* Повторный скоринг при обработке заявки, информирование клиента "предварительное одобрение, финальное решение после проверки"
- **Риск 4:** Система скоринга перегружена → медленные ответы, таймауты
  - *Митигация:* Горизонтальное масштабирование, rate limiting, мониторинг, кэширование
- **Риск 5:** Кредитный конвейер не справляется с объёмом заявок в реальном времени
  - *Митигация:* Kafka буферизирует заявки, горизонтальное масштабирование Кредитного конвейера, приоритизация

---

## Метрики успеха

### Технические метрики:
- Доступность Credit Application Service: > 99.9%
- Latency API Credit Application Service: < 200 мс (95 перцентиль)
- Время мгновенного решения для новых клиентов: < 5 секунд
- Batch-процесс: завершение до 06:00 (100%)
- Успешность вызовов БКИ: > 98%
- Количество предодобренных предложений: > 20% от всех клиентов

### Бизнес-метрики:
- Конверсия предодобренное предложение → заявка: > 20%
- Время обработки предодобренных заявок: < 1 рабочий день (80% заявок)
- Время обработки обычных заявок: < 3 рабочих дней (снижение с 7 дней)
- Конверсия заявка → выданный кредит: > 60%
- Увеличение объёма выдачи кредитов: +50% через 6 месяцев
- Снижение количества визитов в отделения (только для выдачи кредитов): -40%
- NPS (Net Promoter Score) для процесса кредитования: > 70

---

## Зависимости

- **Зависит от:** Task 3 (MVP депозитов) - базовая платформа микросервисов, Kafka, API Gateway
- **Зависит от:** Task 4 (RoadMap месяцы 10-12) - запланировано после автоматизации депозитов
- **Блокирует:** Запуск маркетинговой кампании по онлайн-кредитам
- **Параллельно:** Может разрабатываться параллельно с автоматизацией депозитов (месяцы 7-9)

---

## Следующие шаги

1. Утверждение архитектурного решения стейкхолдерами
2. Разработка Credit Application Service (4 недели)
3. Доработка системы скоринга (batch-процесс, instant API) (3 недели)
4. Разработка Кредитный конвейер Integration Adapter (2 недели)
5. Доработки в интернет-банке (2 недели)
6. Доработки на сайте (1.5 недели)
7. Доработки в Кредитном конвейере (приоритизация, UI) (2 недели)
8. Интеграционное тестирование (2 недели)
9. Нагрузочное тестирование (1 неделя)
10. UAT с бизнесом (1 неделя)
11. Запуск в продакшен

**Общий срок:** ~12-14 недель (~3 месяца)
